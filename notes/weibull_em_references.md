# Grouped Weibull EM / Conditional MLE Notes

This note captures the key equations and implementation details pulled from the ForestFit
reference set (`reference-papers/forestfit-refs`) that we will follow while replacing the current
least-squares grouped Weibull estimator.

## Core references

- Johnson, N. L. (1949). *Systems of frequency curves generated by methods of translation*.
  Provides the grouped likelihood form `ℓ(θ) = \sum_j n_j \log(F(u_j; θ) - F(l_j; θ))` when tally
  classes are defined by bin bounds `l_j, u_j`.
- Siekierski, R. (1992). *Conditional maximum likelihood estimation for the Weibull distribution*.
  Derives the grouped score equations for the three-parameter Weibull and confirms the conditional
  treatment of the location parameter `α = \min(DBH) - c` (typically
  `c \in [0.5, 1.5]` cm) used in ForestFit’s CML implementation.
- Zhang, L. et al. (2011). *A comparison of estimation methods for fitting Weibull and Johnson SB
  distributions to mixed spruce–fir stands*. Equation (3) reproduces the Johnson-style grouped log
  likelihood, and the paper documents ForestFit’s choice of CML (Johnson 1949; Siekierski 1992) and
  the warm-start constants used in production (Table 1).
- Teimouri, M. et al. (2013). *Comparison of estimation methods for the Weibull distribution*.
  Summarises iterative maximum-likelihood updates for the three-parameter Weibull, noting the need
  for numerical solves of the shape equation (Equation 3.1 of the paper). We will reuse their
  Newton step inside the grouped likelihood rather than attempting a closed-form EM update for the
  general case.

## Implementation guidance distilled from the papers

1. **Grouped log-likelihood:**
   \[
   \ell(α, β, γ) = \sum_{j=1}^k n_j \log\big(F(u_j; α, β, γ) - F(l_j; α, β, γ)\big)
   \]
   with `F` the Weibull CDF, bin edges `l_j, u_j`, and `n_j` observed (expanded) counts. When
   forcing the LS amplitude we set `γ = 1` equivalent by scaling the CDF difference with the
   observed total.

2. **Location handling:**
   Following Zhang et al. (2011), enforce `α = \min(DBH) - c` for CML runs. ForestFit’s defaults
   use `c ∈ {0.5, 1.0, 1.5, 2.0}` cm; we will expose a single configurable offset with a default of
   `c = 0.5 cm` to match their “best” setting.

3. **Shape/scale updates:**
   - Start from the current least-squares solution (`a_ls`, `β_ls`) to guarantee manuscript parity.
   - Iterate Newton steps on the grouped score equations (Johnson 1949, Siekierski 1992) or, as an
     initial fallback, minimise the negative grouped log-likelihood using L-BFGS-B (`log` reparameterisation).
   - Continue to reuse the LS-derived amplitude `s_ls = ∑ n_j` so regression tests continue to lock
     the manuscript PSP output.

4. **Convergence safeguards:**
   - Abort the grouped step if RSS increases or if parameters deviate more than `1e-3` relative to the
     LS solution (current guard already in place).
   - Attach covariance via the observed information matrix (negative Hessian) evaluated numerically
     at the converged optimum, mirroring Siekierski’s recommendation when analytic second
     derivatives are cumbersome.

5. **Testing targets:**
   - Manuscript PSP tallies (`examples/hps_baf12/4000002_PSP1_v1_p1.csv`) must continue to report
     the published Weibull parameters and RSS.
   - ForestFit spruce–fir sample plots (digitise from Zhang et al. Appendix) will serve as secondary
     fixtures to validate convergence against CML outputs reported in their Table 2.

## Next steps

- Implement the grouped log-likelihood helper returning value, gradient, and Hessian for
  `(α, β)` with `α` fixed via the PSP offset.
- Replace the current L-BFGS minimisation (which omits amplitude bounds) with a Newton-style
  update using the derived score/Hessian, falling back to the LS solution when stability issues are
  detected.
- Add fixtures summarised above and document the offset choice in the HPS how-to guide once the EM
  solver passes parity.
